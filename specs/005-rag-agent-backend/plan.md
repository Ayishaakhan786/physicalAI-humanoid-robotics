# Implementation Plan: Agent-Based Retrieval & Answering Backend

**Project Name**: RAG Chatbot - Spec-3: Agent-Based Retrieval & Answering Backend
**Feature Branch**: `005-rag-agent-backend`
**Created**: 2025-12-18
**Status**: Draft

## Problem Statement

A production-ready RAG backend is needed to answer user questions using retrieved book content only. This backend will leverage the OpenAI Agents SDK for agent orchestration and FastAPI for API exposure. It must provide strictly grounded, retrieval-augmented responses, refuse to answer with insufficient context, and expose a single `/query` endpoint returning structured JSON.

## Proposed Solution

Develop a Python-based FastAPI application that hosts an OpenAI Agents SDK-powered RAG agent. The agent will integrate with the Spec-2 validated retrieval pipeline to fetch relevant book content from Qdrant. The FastAPI backend will expose a `/query` endpoint to accept user questions, pass them to the RAG agent, and return structured JSON responses, including the agent's grounded answer and source citations.

---

## Technical Context

### Key Technologies & Services
-   **Language**: Python
-   **Web Framework**: FastAPI
-   **ASGI Server**: Uvicorn
-   **Agent Orchestration**: OpenAI Agents SDK
-   **Embedding Provider**: Cohere (`embed-english-v3.0` model, consistent with Spec-1)
-   **Vector Database**: Qdrant Cloud (existing `rag_embedding` collection)
-   **LLM Provider**: OpenAI API (or compatible LLM for Agents SDK, e.g., via `liteLLM`)
-   **Environment/Dependency Management**: `uv` (reusing from Spec-1)

### Constraints
-   Use OpenAI Agents SDK for agent orchestration.
-   Retrieval must use the Spec-2 validated pipeline (i.e., `retrieve_chunks` and `embed_query` functions).
-   No hardcoded answers or prompt stuffing; answers must originate from agent reasoning on retrieved context.
-   FastAPI must expose a single `/query` HTTP POST endpoint.
-   Backend must run locally without any frontend dependency for development and testing.
-   Answers must be strictly grounded in retrieved content.
-   Agent must refuse to answer or indicate insufficient context when needed.

### Assumptions
-   OpenAI API key (or a compatible LLM API key configured for use with OpenAI Agents SDK) will be provided.
-   The Spec-2 validated retrieval pipeline (`retrieve_chunks` and `embed_query` functions) is stable, readily available as Python modules, and performs as expected.
-   The `rag_embedding` Qdrant collection is populated and accessible, containing embeddings generated by the Cohere `embed-english-v3.0` model.
-   The Python environment (with `uv` and required libraries) from Spec-1/Spec-2 is set up and functional.
-   FastAPI request and response schemas are well-defined for clear API interaction.
-   "Production-safe" implies proper error handling, structured logging, input validation, and secure environment variable management.

---

## Constitution Check

The `constitution.md` file in `.specify/memory/` appears to be a template and does not define concrete project principles. Therefore, a full constitution check cannot be performed at this stage. It is assumed that once project-specific constitutional principles are established, this plan will be reviewed against them. (Refer to ADR-0001: Undefined Project Constitution).

---

## Gates

### Initial Gate: Specification Review
-   **Status**: PASS
-   **Justification**: The feature specification (`spec.md`) for "Agent-Based Retrieval & Answering Backend" has been reviewed. All requirements are clear, testable, and free of `[NEEDS CLARIFICATION]` markers. User stories are well-defined, and success criteria are measurable and technology-agnostic.

---

## Phases

### Phase 0: Outline & Research

**Goal**: To resolve technical unknowns regarding OpenAI Agents SDK integration, prompt engineering for grounding, and FastAPI backend architecture.

#### Research Tasks

-   **R-001**: Research OpenAI Agents SDK setup and usage:
    -   Focus: How to instantiate an agent, define custom tools (specifically for our Qdrant retrieval pipeline), and orchestrate agent execution for a RAG workflow.
    -   Focus: Understand agent configuration, model selection, and managing agent state.
-   **R-002**: Investigate prompt engineering for RAG agents:
    -   Focus: Strategies for crafting agent system prompts and tool descriptions to ensure strict context grounding.
    -   Focus: Techniques to encourage the agent to explicitly refuse answers when retrieved context is insufficient or irrelevant.
    -   Focus: Best practices for incorporating retrieved chunks into the agent's context effectively.
-   **R-003**: Research FastAPI backend best practices:
    -   Focus: Building a single `/query` POST endpoint with request and response Pydantic models.
    -   Focus: Implementing dependency injection for Qdrant client, Cohere client, and agent components.
    -   Focus: Error handling strategies within FastAPI for agent failures, retrieval errors, and invalid inputs.
-   **R-004**: Integrate retrieval pipeline (Spec-2) into agent tools:
    -   Focus: How to correctly pass necessary configurations (API keys, collection name) to the retrieval tool within the agent's environment.
    -   Focus: Ensuring the retrieval tool's output is well-structured and easily consumable by the agent.

#### Consolidated Findings (`research.md`)

*This section will be populated upon completion of the research tasks.*

---

### Phase 1: Design & Contracts

**Prerequisites**: All research tasks from Phase 0 are completed, and `research.md` is populated.

**Goal**: To define the API contracts (FastAPI endpoints), data models for API interaction, and provide a quickstart guide for the backend.

#### Data Model (`data-model.md`)

Based on the `Key Entities` identified in the feature specification, the following data models for API interaction will be defined (using Pydantic):

-   **QueryRequest**:
    -   `question` (string): The user's natural language question.
-   **Source**: (Metadata for a retrieved chunk, used in AgentResponse)
    -   `source_url` (HttpUrl): URL of the original Docusaurus page.
    -   `document_section` (string, optional): Section from where the chunk originated.
    -   `heading` (string, optional): Heading of the chunk.
    -   `chunk_id` (string): Unique identifier for the chunk.
    -   `chunk_text_preview` (string): A short preview of the chunk's text.
-   **AgentResponse**:
    -   `answer` (string): The agent's generated answer or refusal message.
    -   `sources` (List[Source], optional): List of sources used to generate the answer. Empty if no answer or no sources.
-   **ErrorResponse**:
    -   `detail` (string): A descriptive error message.
    -   `status_code` (int): HTTP status code.

#### Internal API Contracts (FastAPI Endpoint)

This section defines the external-facing API contract for the RAG backend.

-   **Endpoint**: `/query`
    -   **Method**: `POST`
    -   **Description**: Accepts a user question and returns a grounded answer from the RAG agent.
    -   **Request Body**:
        -   **Schema**: `QueryRequest` (JSON)
        -   **Example**: `{"question": "How do I install ROS2?"}`
    -   **Response Body (Success 200 OK)**:
        -   **Schema**: `AgentResponse` (JSON)
        -   **Example**: `{"answer": "To install ROS2...", "sources": [{"source_url": "...", "chunk_id": "..."}]}`
    -   **Response Body (Error 4xx/5xx)**:
        -   **Schema**: `ErrorResponse` (JSON)
        -   **Example**: `{"detail": "Question is too vague.", "status_code": 400}`

#### Quickstart (`quickstart.md`)

*This will be generated in a separate step after the initial plan.md is complete.* Will focus on how to set up, run the FastAPI application, and test the `/query` endpoint.

---

### Agent Context Update

*This will be done after `Phase 1` content is generated.*

---

I will now write this content to `specs/005-rag-agent-backend/plan.md`.