# Data Model: RAG Retrieval Pipeline & Validation

**Feature**: 004-rag-retrieval-validation
**Date**: 2025-12-18

## Overview

This document describes the key data entities involved in the RAG retrieval pipeline and validation process, outlining their structure, attributes, and relationships. These entities extend or utilize models defined in Spec-1 and directly correspond to the `Key Entities` identified in the feature specification for retrieval.

## Entities

### 1. Query

Represents a natural language input provided by the user to search for relevant information.

-   **`query_text`** (string): The actual text string of the query (e.g., "How do I set up Isaac Sim?").
-   **`query_vector`** (List[float]): The numerical vector embedding of the `query_text`, generated by the Cohere model.
-   **`embedding_model_name`** (string): The name of the Cohere model used for embedding the query (e.g., `embed-english-v3.0`).

### 2. RetrievedChunk (Extended from Spec-1 TextChunk)

Represents a `TextChunk` that has been identified as semantically similar to the `Query` and returned by the Qdrant search. It is an extension of the `TextChunk` entity from Spec-1, containing its original text content and enriched with retrieval-specific information.

-   **`id`** (string): Unique identifier for the chunk.
-   **`text`** (string): The actual textual content of the chunk.
-   **`source_url`** (string): The URL of the `DocusaurusPage` from which this chunk was derived.
-   **`document_section`** (string, optional): A categorisation of the content within the overall book structure.
-   **`heading`** (string, optional): The closest major heading preceding the chunk.
-   **`chunk_text_preview`** (string): A short, truncated version of the chunk text.

### 3. RetrievedResult

A structured object or tuple containing a `Retrieved Chunk` and its associated relevance `score` from the vector database. This corresponds directly to a `ScoredPoint` object from the Qdrant client.

-   **`chunk_id`** (string): The `id` of the `RetrievedChunk` (maps to Qdrant `point_id`).
-   **`score`** (float): The relevance score indicating how semantically similar the chunk is to the query vector (e.g., cosine similarity).
-   **`retrieved_chunk_metadata`** (EmbeddingMetadata): The full metadata payload associated with the chunk in Qdrant (including `source_url`, `document_section`, `heading`, `chunk_id`, `page_title`, etc.).
-   **`retrieved_chunk_text`** (string): The full text content of the retrieved chunk, extracted from `retrieved_chunk_metadata.chunk_text_preview` (or potentially a full text field if stored).

### 4. RetrievalTestCase

Represents a single test case for evaluating the retrieval pipeline.

-   **`query`** (string): The natural language query string for the test.
-   **`expected_chunk_ids`** (List[string]): A list of `chunk_id`s that are considered to be highly relevant and should ideally appear in the top results.
-   **`expected_fragments`** (List[string], optional): A list of text fragments expected to be present within the top retrieved chunk texts. Useful for qualitative assessment.
-   **`min_score_threshold`** (float, optional): A minimum relevance score below which results should be considered irrelevant.
-   **`is_out_of_scope`** (bool): `True` if this query is deliberately designed to be outside the content's scope and should ideally yield no relevant results.

### 5. Qdrant Search Request

The parameters sent to Qdrant for a search operation using a pre-embedded query vector.

-   **`collection_name`** (string): The name of the Qdrant collection to search (`rag_embedding`).
-   **`query_vector`** (List[float]): The `Query Embedding` vector.
-   **`limit`** (int): Maximum number of results to return.
-   **`with_payload`** (bool): Whether to retrieve the associated metadata (payload).
-   **`with_vectors`** (bool): Whether to retrieve the actual vectors (usually `False` for retrieval).
-   **`query_filter`** (Qdrant `Filter`, optional): Filters to apply on metadata (e.g., `document_section` filter).
-   **`score_threshold`** (float, optional): Only return points with a score greater than this value.

### 6. Qdrant Search Response

The structured response received from Qdrant containing a list of `RetrievedResult`s (ScoredPoint objects).

-   **`results`** (List[RetrievedResult]): A list of `RetrievedResult`s, ranked by score.
-   **`time_taken_ms`** (int): Time taken by Qdrant to process the search request.

## Relationships

-   A `Query` is transformed into a `Query Embedding`.
-   A `Qdrant Search Request` uses a `Query Embedding` to query a `Qdrant Collection` (from Spec-1).
-   A `Qdrant Search Response` contains multiple `RetrievedResult`s.
-   Each `RetrievedResult` includes a `RetrievedChunk` and its `EmbeddingMetadata` (from Spec-1).
-   `RetrievalTestCase`s are used to validate `RetrievedResult`s.

## Validation Rules (Examples)

-   `Query.query_text`: Cannot be empty.
-   `Query.query_vector`: Must have a `dimensionality` matching the Cohere model.
-   `RetrievedResult.score`: Must be between -1.0 and 1.0 for cosine similarity.
-   `RetrievalTestCase.query`: Cannot be empty.
-   `RetrievalTestCase.expected_chunk_ids`: Should contain valid `chunk_id`s present in the collection.